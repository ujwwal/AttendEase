{% extends 'base.html' %}

{% block title %}Mark Attendance - AttendEase{% endblock %}

{% block content %}
<div class="mark-attendance">
    <header class="page-header">
        <a href="{{ url_for('dashboard') }}" class="back-link">â† Back to Dashboard</a>
        <h1>Mark Attendance</h1>
        <p>Record your attendance for today</p>
    </header>

    <form method="POST" class="attendance-form">
        <div class="date-selector">
            <label for="date">Select Date</label>
            <input type="date" id="date" name="date" value="{{ target_date.isoformat() }}" max="{{ today.isoformat() }}"
                onchange="window.location.href='{{ url_for('mark_attendance') }}?date=' + this.value">
        </div>

        <div class="subjects-list">
            {% for subject in subjects %}
            <div class="attendance-item {% if subject.already_marked %}already-marked{% endif %}"
                data-subject="{{ subject.id }}">
                <div class="subject-info">
                    <h3>{{ subject.name }}</h3>
                    {% if subject.already_marked %}
                    <span class="marked-badge">Previously marked: {{ subject.lectures_present }}/{{
                        subject.lectures_total }} lectures</span>
                    {% endif %}
                </div>

                <div class="attendance-controls">
                    <!-- Number of Lectures Dropdown -->
                    <div class="lectures-dropdown">
                        <label for="lectures_{{ subject.id }}">Lectures Today</label>
                        <select name="lectures_{{ subject.id }}" id="lectures_{{ subject.id }}"
                            class="lecture-count-select" data-subject="{{ subject.id }}">
                            <option value="0" {% if subject.lectures_total==0 %}selected{% endif %}>No Lecture</option>
                            <option value="1" {% if subject.lectures_total==1 or (not subject.already_marked and
                                subject.lectures_total !=0) %}selected{% endif %}>1 Lecture</option>
                            <option value="2" {% if subject.lectures_total==2 %}selected{% endif %}>2 Lectures</option>
                            <option value="3" {% if subject.lectures_total==3 %}selected{% endif %}>3 Lectures</option>
                        </select>
                    </div>

                    <!-- Attendance Status Buttons -->
                    <div class="status-buttons" id="status_{{ subject.id }}" {% if subject.lectures_total==0
                        %}style="display: none;" {% endif %}>
                        <input type="hidden" name="status_{{ subject.id }}" id="status_value_{{ subject.id }}"
                            value="{% if subject.already_marked %}{% if subject.lectures_present == subject.lectures_total %}present{% elif subject.lectures_present == 0 %}absent{% else %}present{% endif %}{% else %}present{% endif %}">

                        <button type="button"
                            class="status-btn present {% if not subject.already_marked or subject.lectures_present == subject.lectures_total %}active{% endif %}"
                            data-status="present" data-subject="{{ subject.id }}">
                            <span class="status-icon">âœ“</span>
                            <span class="status-text">Present</span>
                        </button>
                        <button type="button"
                            class="status-btn absent {% if subject.already_marked and subject.lectures_present == 0 %}active{% endif %}"
                            data-status="absent" data-subject="{{ subject.id }}">
                            <span class="status-icon">âœ—</span>
                            <span class="status-text">Absent</span>
                        </button>
                    </div>

                    <div class="no-lecture-indicator" id="no_lecture_{{ subject.id }}" {% if subject.lectures_total !=0
                        %}style="display: none;" {% endif %}>
                        <span class="no-lecture-text">ğŸ“­ No lecture today</span>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <div class="quick-actions">
            <button type="button" class="btn btn-outline" id="markAllNoLecture">
                <span>ğŸ“­ All No Lecture</span>
            </button>
            <button type="button" class="btn btn-outline" id="markAllPresent">
                <span>âœ… All Present</span>
            </button>
            <button type="button" class="btn btn-outline" id="markAllAbsent">
                <span>âŒ All Absent</span>
            </button>
        </div>

        <button type="submit" class="btn btn-primary btn-full">
            <span>Save Attendance</span>
            <span class="btn-icon">ğŸ’¾</span>
        </button>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Handle lecture count dropdown changes
    document.querySelectorAll('.lecture-count-select').forEach(select => {
        select.addEventListener('change', function () {
            const subjectId = this.dataset.subject;
            const lectureCount = parseInt(this.value);
            const statusButtons = document.getElementById('status_' + subjectId);
            const noLectureIndicator = document.getElementById('no_lecture_' + subjectId);

            if (lectureCount === 0) {
                // No lecture - hide status buttons, show no lecture indicator
                statusButtons.style.display = 'none';
                noLectureIndicator.style.display = 'flex';
            } else {
                // Has lectures - show status buttons, hide no lecture indicator
                statusButtons.style.display = 'flex';
                noLectureIndicator.style.display = 'none';
            }
        });
    });

    // Handle status button clicks
    document.querySelectorAll('.status-btn').forEach(btn => {
        btn.addEventListener('click', function () {
            const subjectId = this.dataset.subject;
            const status = this.dataset.status;
            const hiddenInput = document.getElementById('status_value_' + subjectId);
            const container = this.parentElement;

            // Remove active class from all buttons in this group
            container.querySelectorAll('.status-btn').forEach(b => b.classList.remove('active'));

            // Add active class to clicked button
            this.classList.add('active');

            // Update hidden input value
            hiddenInput.value = status;
        });
    });

    // Quick action: All No Lecture
    document.getElementById('markAllNoLecture').addEventListener('click', function () {
        document.querySelectorAll('.lecture-count-select').forEach(select => {
            select.value = '0';
            select.dispatchEvent(new Event('change'));
        });
    });

    // Quick action: All Present (1 lecture, present)
    document.getElementById('markAllPresent').addEventListener('click', function () {
        document.querySelectorAll('.lecture-count-select').forEach(select => {
            select.value = '1';
            select.dispatchEvent(new Event('change'));

            const subjectId = select.dataset.subject;
            const presentBtn = document.querySelector(`.status-btn.present[data-subject="${subjectId}"]`);
            if (presentBtn) {
                presentBtn.click();
            }
        });
    });

    // Quick action: All Absent (1 lecture, absent)
    document.getElementById('markAllAbsent').addEventListener('click', function () {
        document.querySelectorAll('.lecture-count-select').forEach(select => {
            select.value = '1';
            select.dispatchEvent(new Event('change'));

            const subjectId = select.dataset.subject;
            const absentBtn = document.querySelector(`.status-btn.absent[data-subject="${subjectId}"]`);
            if (absentBtn) {
                absentBtn.click();
            }
        });
    });
</script>
{% endblock %}